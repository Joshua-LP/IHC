// ========================================
// TRANSLATIONS SYSTEM
// ========================================

const translations = {
    es: {
        // Login Screen
        discover_peru: "Descubre PerÃº",
        explore_heritage: "Explora la rica herencia cultural del PerÃº, desde maravillas antiguas hasta tradiciones vibrantes.",
        accessibility: "Accesibilidad",
        high_contrast: "Alto Contraste",
        voice_reader: "Lector de Voz",
        large_font: "Fuente Grande",
        language: "Idioma",
        sign_in: "Iniciar SesiÃ³n",
        sign_up: "Registrarse",
        explore_guest: "Explorar como Invitado",
        terms_agree: "Al continuar, aceptas nuestros",
        terms_service: "TÃ©rminos de Servicio",
        and: "y",
        privacy_policy: "PolÃ­tica de Privacidad",
        
        // Home Screen
        hello: "Hola",
        search_placeholder: "Buscar eventos, museos, patrimonios...",
        filter_type: "Tipo",
        filter_region: "RegiÃ³n",
        filter_accessibility: "Accesibilidad",
        nearby_events: "Eventos Cercanos",
        museums_heritage: "Museos y Patrimonios",
        free_activities: "Actividades Gratuitas o Accesibles",
        personal_stats: "EstadÃ­sticas Personales",
        events: "Eventos",
        museums: "Museos",
        heritage: "Patrimonios",
        explore_culture: "Explorar Cultura",
        
        // Events
        andean_music_festival: "Festival de MÃºsica Andina",
        traditional_music_dances: "MÃºsica tradicional y danzas",
        prehispanic_art_exhibition: "ExposiciÃ³n de Arte PrehispÃ¡nico",
        ceramics_textiles: "CerÃ¡mica y textiles",
        
        // Museums
        national_archaeology_museum: "Museo Nacional de ArqueologÃ­a",
        national_archaeology_desc: "El museo mÃ¡s antiguo del PerÃº con colecciones desde la prehistoria",
        ancient_artifacts_collection: "ColecciÃ³n de artefactos antiguos",
        chan_chan_citadel: "Ciudadela de Chan Chan",
        chimu_culture_ruins: "Ruinas de la cultura ChimÃº",
        
        // Map Screen
        interactive_map: "Mapa Interactivo",
        cultural_map_subtitle: "Descubre eventos y lugares culturales en todo el PerÃº",
        all_regions: "Todas las Regiones",
        lima_metropolitan: "Lima Metropolitana",
        cusco_region: "Cusco - Ombligo del Mundo",
        north_coast: "Costa Norte",
        peruvian_highlands: "Sierra Peruana",
        capital_kings: "Capital del PerÃº, ciudad de reyes",
        historical_capital_inca: "Capital histÃ³rica del Imperio Inca",
        beaches_deserts: "Playas, desiertos y civilizaciones antiguas",
        mountains_traditions: "MontaÃ±as, tradiciones y cultura ancestral",
        
        // Activities
        historic_center_tour: "Recorrido por el Centro HistÃ³rico",
        colonial_architecture_plazas: "Arquitectura colonial y plazas",
        handicraft_workshops: "Talleres de ArtesanÃ­a",
        ceramics_weaving_classes: "Clases de cerÃ¡mica y tejido",
        
        // Event Detail
        event_view: "Vista de Evento",
        marinera_festival: "Festival de la Marinera",
        marinera_description: "Disfruta de la elegancia y pasiÃ³n de la Marinera, danza nacional del PerÃº, en un evento lleno de color, mÃºsica y tradiciÃ³n.",
        accessibility_info: "Accesibilidad...",
        save: "Guardar",
        share: "Compartir",
        attend: "Asistir",
        view_map: "Ver en mapa",
        might_interest: "TambiÃ©n te puede interesar...",
        andean_textile_art: "Arte Textil Andino",
        discover_richness: "Descubre la riqueza de los tejidos andinos",
        machu_picchu_wonders: "Maravillas de Machu Picchu",
        explore_citadel: "Explora la ciudadela inca de Machu Picchu...",
        
        // My Culture Screen
        my_culture: "Mi Cultura",
        my_achievements: "Mis Logros",
        visited_museums: "Museos Visitados",
        participated_workshops: "Talleres Participados",
        explored_regions: "Regiones Exploradas",
        cultural_progress: "Progreso Cultural",
        general_progress: "Progreso General",
        total: "Total",
        preferences: "Preferencias",
        preferred_language: "Mi idioma Preferido",
        accessible_mode: "Modo Accesible",
        spanish: "EspaÃ±ol",
        disabled: "Desactivado",
        
        // Community Screen
        community: "Comunidad",
        region: "RegiÃ³n",
        theme: "TemÃ¡tica",
        featured_posts: "Publicaciones destacadas",
        exploring_machu_picchu: "Explorando la magia de Machu Picchu",
        machu_picchu_description: "Descubre la ciudadela inca a travÃ©s de mis ojos. Un viaje inolvidable lleno de historia y paisajes impresionantes.",
        days_ago_2: "Hace 2 dÃ­as",
        ancestral_dances: "Danzas ancestrales de la sierra",
        dances_description: "PresenciÃ© una presentaciÃ³n de danzas tradicionales en un pueblo andino. La energÃ­a y el colorido de los trajes fueron fascinantes.",
        week_ago: "Hace 1 semana",
        northern_flavors: "Sabores del norte: Ceviche y mÃ¡s",
        ceviche_description: "ProbÃ© el mejor ceviche de mi vida en un restaurante local. La frescura de los ingredientes y la combinaciÃ³n de sabores fueron excepcionales.",
        weeks_ago_3: "Hace 3 semanas",
        create_post: "Crear publicaciÃ³n",
        
        // Navigation
        home: "Inicio",
        map: "Mapa",
        my_culture_nav: "Mi Cultura",
        community_nav: "Comunidad",
        
        // Notificaciones
        msg_voice_activated: "Lector de voz activado",
        msg_voice_deactivated: "Lector de voz desactivado",
        msg_contrast_activated: "Alto contraste activado",
        msg_contrast_deactivated: "Alto contraste desactivado",
        msg_font_increased: "TamaÃ±o de fuente aumentado",
        msg_font_decreased: "TamaÃ±o de fuente reducido",
        msg_font_reset: "TamaÃ±o de fuente restablecido"
    },
    
    en: {
        // Login Screen
        discover_peru: "Discover Peru",
        explore_heritage: "Explore the rich cultural heritage of Peru, from ancient wonders to vibrant traditions.",
        accessibility: "Accessibility",
        high_contrast: "High Contrast",
        voice_reader: "Voice Reader",
        large_font: "Large Font",
        language: "Language",
        sign_in: "Sign In",
        sign_up: "Sign Up",
        explore_guest: "Explore as Guest",
        terms_agree: "By continuing, you agree to our",
        terms_service: "Terms of Service",
        and: "and",
        privacy_policy: "Privacy Policy",
        
        // Home Screen
        hello: "Hello",
        search_placeholder: "Search events, museums, heritage sites...",
        filter_type: "Type",
        filter_region: "Region",
        filter_accessibility: "Accessibility",
        nearby_events: "Nearby Events",
        museums_heritage: "Museums and Heritage Sites",
        free_activities: "Free or Accessible Activities",
        personal_stats: "Personal Statistics",
        events: "Events",
        museums: "Museums",
        heritage: "Heritage Sites",
        explore_culture: "Explore Culture",
        
        // Events
        andean_music_festival: "Andean Music Festival",
        traditional_music_dances: "Traditional music and dances",
        prehispanic_art_exhibition: "Prehispanic Art Exhibition",
        ceramics_textiles: "Ceramics and textiles",
        
        // Museums
        national_archaeology_museum: "National Museum of Archaeology",
        national_archaeology_desc: "Peru's oldest museum with collections from prehistory",
        ancient_artifacts_collection: "Collection of ancient artifacts",
        chan_chan_citadel: "Chan Chan Citadel",
        chimu_culture_ruins: "Ruins of the ChimÃº culture",
        
        // Map Screen
        interactive_map: "Interactive Map",
        cultural_map_subtitle: "Discover cultural events and places throughout Peru",
        all_regions: "All Regions",
        lima_metropolitan: "Metropolitan Lima",
        cusco_region: "Cusco - Navel of the World",
        north_coast: "North Coast",
        peruvian_highlands: "Peruvian Highlands",
        capital_kings: "Capital of Peru, city of kings",
        historical_capital_inca: "Historical capital of the Inca Empire",
        beaches_deserts: "Beaches, deserts and ancient civilizations",
        mountains_traditions: "Mountains, traditions and ancestral culture",
        
        // Activities
        historic_center_tour: "Historic Center Tour",
        colonial_architecture_plazas: "Colonial architecture and plazas",
        handicraft_workshops: "Handicraft Workshops",
        ceramics_weaving_classes: "Ceramics and weaving classes",
        
        // Event Detail
        event_view: "Event View",
        marinera_festival: "Marinera Festival",
        marinera_description: "Enjoy the elegance and passion of Marinera, Peru's national dance, in an event full of color, music and tradition.",
        accessibility_info: "Accessibility...",
        save: "Save",
        share: "Share",
        attend: "Attend",
        view_map: "View on map",
        might_interest: "You might also like...",
        andean_textile_art: "Andean Textile Art",
        discover_richness: "Discover the richness of Andean textiles",
        machu_picchu_wonders: "Wonders of Machu Picchu",
        explore_citadel: "Explore the Inca citadel of Machu Picchu...",
        
        // My Culture Screen
        my_culture: "My Culture",
        my_achievements: "My Achievements",
        visited_museums: "Visited Museums",
        participated_workshops: "Workshops Participated",
        explored_regions: "Explored Regions",
        cultural_progress: "Cultural Progress",
        general_progress: "General Progress",
        total: "Total",
        preferences: "Preferences",
        preferred_language: "My Preferred Language",
        accessible_mode: "Accessible Mode",
        spanish: "Spanish",
        disabled: "Disabled",
        
        // Community Screen
        community: "Community",
        region: "Region",
        theme: "Theme",
        featured_posts: "Featured Posts",
        exploring_machu_picchu: "Exploring the Magic of Machu Picchu",
        machu_picchu_description: "Discover the Inca citadel through my eyes. An unforgettable journey full of history and stunning landscapes.",
        days_ago_2: "2 days ago",
        ancestral_dances: "Ancestral Dances of the Highlands",
        dances_description: "I witnessed a presentation of traditional dances in an Andean village. The energy and colorfulness of the costumes were fascinating.",
        week_ago: "1 week ago",
        northern_flavors: "Northern Flavors: Ceviche and More",
        ceviche_description: "I tried the best ceviche of my life at a local restaurant. The freshness of the ingredients and combination of flavors were exceptional.",
        weeks_ago_3: "3 weeks ago",
        create_post: "Create Post",
        
        // Navigation
        home: "Home",
        map: "Map",
        my_culture_nav: "My Culture",
        community_nav: "Community",
        
        // Notifications
        msg_voice_activated: "Voice reader activated",
        msg_voice_deactivated: "Voice reader deactivated",
        msg_contrast_activated: "High contrast activated",
        msg_contrast_deactivated: "High contrast deactivated",
        msg_font_increased: "Font size increased",
        msg_font_decreased: "Font size decreased",
        msg_font_reset: "Font size reset"
    },
    
    qu: {
        // Login Screen (Quechua)
        discover_peru: "Peruta Riqsichiy",
        explore_heritage: "Perupa sumaq kawsayninta riqsichiy, Ã±awpa kawsaymanta kunan kawsaykama.",
        accessibility: "Yanapay",
        high_contrast: "Hatun Llimp'i",
        voice_reader: "Kunka Ã‘awiry",
        large_font: "Hatun Qillqa",
        language: "Rimay",
        sign_in: "Yaykuy",
        sign_up: "Qillqakuy",
        explore_guest: "Watukuq hina Purichiy",
        terms_agree: "Purispayki, munankichu",
        terms_service: "Serviciopa Kamachikuynin",
        and: "chaymanta",
        privacy_policy: "Sapalla Kaypaq Kamachikuy",
        
        // Home Screen
        hello: "Napaykullayki",
        search_placeholder: "Maskay raymikuna, museokuna, qhapaq Ã±ankunata...",
        filter_type: "Laya",
        filter_region: "Suyu",
        filter_accessibility: "Yanapay",
        nearby_events: "Qayllay Raymikuna",
        museums_heritage: "Museokuna QhapaqÃ±ankuna",
        free_activities: "Mana Qullqiyuq Ruwaykuna",
        personal_stats: "Kikinmanta Yupay",
        events: "Raymikuna",
        museums: "Museokuna",
        heritage: "QhapaqÃ±an",
        explore_culture: "Kawsayta Riqsichiy",
        
        // Events
        andean_music_festival: "Andinukunapa Takiy Raymi",
        traditional_music_dances: "Ã‘awpa takikuna tusukuna",
        prehispanic_art_exhibition: "Ã‘awpaq EspaÃ±olkuna Chayamunankupaq Arte",
        ceramics_textiles: "Mankakuna Awasqakuna",
        
        // Museums
        national_archaeology_museum: "Mama Llaqtapa ArqueologÃ­a Museon",
        national_archaeology_desc: "PerÃºpa Ã±awpaq museonta Ã±awpamanta",
        ancient_artifacts_collection: "Ã‘awpa Ruwanakuna HuÃ±u",
        chan_chan_citadel: "Chan Chan Hatun Llaqta",
        chimu_culture_ruins: "ChimÃº Kawsaypa Ruranakuna",
        
        // Map Screen
        interactive_map: "Yanapaq Mapa",
        cultural_map_subtitle: "PerÃº llaqtapi kawsay raymikuna riqsichiy",
        all_regions: "Tukuy Suyukuna",
        lima_metropolitan: "Lima Hatun Llaqta",
        cusco_region: "Cusco - Kay Pachapa Pukan",
        north_coast: "Chinchay Suyu Quchakuna",
        peruvian_highlands: "PerÃº Urqukuna",
        capital_kings: "PerÃºpa uma llaqtan, capac llaqta",
        historical_capital_inca: "Inca kawsaypa uma llaqtan",
        beaches_deserts: "Playakuna, ch'in pachakuna, Ã±awpa kawsaykuna",
        mountains_traditions: "Urqukuna, kawsaykuna, yachaymasiykuna",
        
        // Activities
        historic_center_tour: "Ã‘awpa Centro Puriy",
        colonial_architecture_plazas: "Colonial Wasikuna Plazakuna",
        handicraft_workshops: "Maki Ruwana Yachaykunawasi",
        ceramics_weaving_classes: "Mankakuna Awana Yachay",
        
        // Event Detail
        event_view: "Raymipa Rikuy",
        marinera_festival: "Marinera Raymi",
        marinera_description: "Marinerapa sumaq kay kallpanta kusikuy, Perupa mama tusun, llimp'ikuna takikuna kawsaywanmi huntasqa.",
        accessibility_info: "Yanapay...",
        save: "Waqaychay",
        share: "Rakiy",
        attend: "Riy",
        view_map: "Mapapi Rikuy",
        might_interest: "Kaykunapas kusisunkiman...",
        andean_textile_art: "Andinukunapa Awasqa Arte",
        discover_richness: "Andinukunapa awasqankunapa qhapaq kayninta riqsiy",
        machu_picchu_wonders: "Machu Picchupa Admirakuyninkuna",
        explore_citadel: "Inkapa hatun llaqtanta riqsichiy...",
        
        // My Culture Screen
        my_culture: "Ã‘uqapa Kawsay",
        my_achievements: "Ã‘uqapa Rikchakuyniy",
        visited_museums: "Museokuna Watukusqa",
        participated_workshops: "Yachaywasikunapi Ruwasqa",
        explored_regions: "Suyukuna Riqsisqa",
        cultural_progress: "Kawsaypa Ã‘awpariy",
        general_progress: "Tukuy Ã‘awpariy",
        total: "Tukuy",
        preferences: "Munasqakuna",
        preferred_language: "Ã‘uqapa Munasqa Rimay",
        accessible_mode: "Yanapay Kaq",
        spanish: "EspaÃ±ol",
        disabled: "Mana Kaq",
        
        // Community Screen
        community: "Ayllu",
        region: "Suyu",
        theme: "Yuyay",
        featured_posts: "Rikuchikuq Willakuykuna",
        exploring_machu_picchu: "Machu Picchupa Admirakuyninkunata Riqsichiy",
        machu_picchu_description: "Inkapa hatun llaqtanta Ã±awiywan riqsichiy. Mana qunqanapaq puriy historiawan paisajesninkunawan hunt'a.",
        days_ago_2: "2 p'unchaw Ã±awpaq",
        ancestral_dances: "Machulapa Tusukuyninkuna",
        dances_description: "Ã‘awpa tususkunata Andino llaqtapi rikurqani. Kallpa llimp'ikunapas kusichiq karqan.",
        week_ago: "1 simana Ã±awpaq",
        northern_flavors: "Chinchaysuyupa Mikhuyninku: Ceviche chaymanta astawan",
        ceviche_description: "Aswan allin cevicheta kawsayniype mikhurqani wakin restaurantpi. Mikhuykunapa musuq kaynin llapallan kusichiq karqan.",
        weeks_ago_3: "3 simana Ã±awpaq",
        create_post: "Willakuyta Ruway",
        
        // Navigation
        home: "Qallariy",
        map: "Mapa",
        my_culture_nav: "Ã‘uqapa Kawsay",
        community_nav: "Ayllu"
    },
    
    ay: {
        // Login Screen (Aymara)
        discover_peru: "Piruw UÃ±jaÃ±ataki",
        explore_heritage: "Piruwan suma jakawip uÃ±jaÃ±ataki, nayra pachanakat jichha pachat kama.",
        accessibility: "Yanapt'awi",
        high_contrast: "Jach'a Sami",
        voice_reader: "Aru Ullawi",
        large_font: "Jach'a Qillqawi",
        language: "Aru",
        sign_in: "MantaÃ±ani",
        sign_up: "QillqaÃ±ani",
        explore_guest: "UÃ±jir jisa SarnaqaÃ±ani",
        terms_agree: "Saraqasaxa, munktati",
        terms_service: "LuraÃ±an Kamachi",
        and: "ukhamaraki",
        privacy_policy: "Mayamp UÃ±naqawi Kamachi",
        
        // Home Screen
        hello: "Kamisaraki",
        search_placeholder: "ThaqhaÃ±ani anatawinaka, museunaka, qullanaka...",
        filter_type: "Kasta",
        filter_region: "Marka",
        filter_accessibility: "Yanapt'awi",
        nearby_events: "Jak'a Anatawinaka",
        museums_heritage: "Museunaka Qullanaka",
        free_activities: "Jan Qullqini Lurawinaka",
        personal_stats: "Kikipa Jakthawi",
        events: "Anatawinaka",
        museums: "Museunaka",
        heritage: "Qulla",
        explore_culture: "Jakawi UÃ±jaÃ±ataki",
        
        // Events
        andean_music_festival: "Andinunakana Q'uchu Anatawi",
        traditional_music_dances: "Nayra q'uchunaka thuqhunaka",
        prehispanic_art_exhibition: "Nayra EspaÃ±olanakanakana Arte UÃ±acht'awi",
        ceramics_textiles: "Mankhanaka Ist'anaka",
        
        // Museums
        national_archaeology_museum: "Markanakana ArqueologÃ­a Museu",
        national_archaeology_desc: "PerÃºna nayra museu nayra pachanakampi",
        ancient_artifacts_collection: "Nayra Lurawinakana Tantachawi",
        chan_chan_citadel: "Chan Chan Jach'a Marka",
        chimu_culture_ruins: "ChimÃº Jakawina Tuqinaka",
        
        // Map Screen
        interactive_map: "Mapa Yanapt'iri",
        cultural_map_subtitle: "PerÃº markanakana jakaÃ±anaka jikxataÃ±ataki",
        all_regions: "Taqi Suyunaka",
        lima_metropolitan: "Lima Jach'a Marka",
        cusco_region: "Cusco - Pachana Chuyma",
        north_coast: "Chincha Suyu Qutanaka",
        peruvian_highlands: "PerÃº Qullanaka",
        capital_kings: "PerÃºna jiliri marka, kapaj marka",
        historical_capital_inca: "Inca jakaÃ±ana jiliri marka",
        beaches_deserts: "Playanaka, ch'uwa pachankiri, nayra jakaÃ±anaka",
        mountains_traditions: "Qullanaka, jakaÃ±anaka, nayra yatiÃ±anaka",
        
        // Activities
        historic_center_tour: "Nayra Centro Sarnaqawi",
        colonial_architecture_plazas: "Colonial Utanaka Plazanaka",
        handicraft_workshops: "Amparanakana YatiÃ± Utanaka",
        ceramics_weaving_classes: "Mankhanaka SawuÃ±a YatiqaÃ±a",
        
        // Event Detail
        event_view: "Anatawina UÃ±jawi",
        marinera_festival: "Marinera Anatawi",
        marinera_description: "Marinerana suma ukat ch'ama kusisiÃ±amawa, Piruwa thuqhupaxa, saminakampi q'uchunampi jakawimpi phuqhatawa.",
        accessibility_info: "Yanapt'awi...",
        save: "ImaÃ±a",
        share: "JaljayaÃ±a",
        attend: "SaraÃ±a",
        view_map: "Mapana UÃ±jaÃ±a",
        might_interest: "Akanakasti juk'ampi kusisipxasma...",
        andean_textile_art: "Andinunakana SawuÃ±a Arte",
        discover_richness: "Andinunakana sawuÃ±anakana qullqipa uÃ±jaÃ±a",
        machu_picchu_wonders: "Machu Picchuna MuspharkaÃ±anakapa",
        explore_citadel: "Inkana jach'a markapa uÃ±jaÃ±ataki...",
        
        // My Culture Screen
        my_culture: "Nayan Jakawi",
        my_achievements: "Nayan Phuqhachawinaka",
        visited_museums: "Museunaka Saratanaka",
        participated_workshops: "YatiÃ± Utanakana LuraÃ±a",
        explored_regions: "Markanaka UÃ±jata",
        cultural_progress: "Jakawina Nayrarparawi",
        general_progress: "Taqi Nayrarparawi",
        total: "Taqi",
        preferences: "Munawinaka",
        preferred_language: "Nayan Munata Aru",
        accessible_mode: "Yanapt'awi Kawi",
        spanish: "EspaÃ±ol",
        disabled: "Jan Kawi",
        
        // Community Screen
        community: "Ayllu",
        region: "Marka",
        theme: "Amuyunaka",
        featured_posts: "UÃ±acht'ayata Yatiyawinaka",
        exploring_machu_picchu: "Machu Picchuna MuspharkaÃ±anakapa UÃ±jaÃ±a",
        machu_picchu_description: "Inkana jach'a markapa nayan nayrampi uÃ±jaÃ±a. Jan armasiÃ±jama sarÃ¤wi saraÃ±Ã¤wi historiampi paisajenakampi phuqhatawa.",
        days_ago_2: "2 uru jaypa",
        ancestral_dances: "Achachilanakana Thuqhunakapa",
        dances_description: "Nayra thuqhunaka Andino markanana uÃ±jtha. Ch'ama ukat saminakasti kusisipxi karqi.",
        week_ago: "1 simana jaypa",
        northern_flavors: "Chinchaysuyuna Manq'anakapa: Ceviche ukat juk'ampi",
        ceviche_description: "Juk'ampi suma ceviche jakÃ¤wjana manq'Ã¤tha walja restaurantena. Manq'anakana machaq ukat taqi kusisipxi karqi.",
        weeks_ago_3: "3 simana jaypa",
        create_post: "Yatiyawi LuraÃ±a",
        
        // Navigation
        home: "Qalltawi",
        map: "Mapa",
        my_culture_nav: "Nayan Jakawi",
        community_nav: "Ayllu",
        
        // Yatiyawinaka (Notificaciones)
        msg_voice_activated: "Aru Ullawi ch'amanchata",
        msg_voice_deactivated: "Aru Ullawi jani ch'amanchata",
        msg_contrast_activated: "Jach'a Sami ch'amanchata",
        msg_contrast_deactivated: "Jach'a Sami jani ch'amanchata",
        msg_font_increased: "Qillqawi jilata",
        msg_font_decreased: "Qillqawi jisk'achata",
        msg_font_reset: "Qillqawi mayamp luraÃ±ataki"
    }
};

let currentLanguage = localStorage.getItem('preferred-language') || 'es';

function translatePage() {
    const elements = document.querySelectorAll('[data-translate]');
    elements.forEach(element => {
        const key = element.getAttribute('data-translate');
        if (translations[currentLanguage] && translations[currentLanguage][key]) {
            const translatedText = translations[currentLanguage][key];
            
            // Traducir placeholder para inputs
            if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                if (element.hasAttribute('placeholder')) {
                    element.placeholder = translatedText;
                }
            } 
            // Traducir contenido de texto
            else {
                element.textContent = translatedText;
        }
    }
});

// ========================================
// LECTOR DE VOZ (VOICE READER)
// ========================================

let isVoiceReaderEnabled = false;
let currentVoice = null;
let isSpeaking = false;

// Inicializar voces
function initializeVoices() {
    return new Promise((resolve) => {
        const voices = window.speechSynthesis.getVoices();
        if (voices.length > 0) {
            resolve(voices);
        } else {
            window.speechSynthesis.onvoiceschanged = () => {
                resolve(window.speechSynthesis.getVoices());
            };
        }
    });
}

// FunciÃ³n para hablar texto
function speakText(text, options = {}) {
    if (!window.speechSynthesis || !isVoiceReaderEnabled) return;
    
    // Limpiar cualquier speech anterior
    window.speechSynthesis.cancel();
    isSpeaking = false;
    
    // Validar texto
    if (!text || text.trim().length === 0) return;
    
    const utterance = new SpeechSynthesisUtterance(text);
    
    // Configurar voz en espaÃ±ol si estÃ¡ disponible
    const voices = window.speechSynthesis.getVoices();
    const spanishVoice = voices.find(voice => 
        voice.lang.startsWith('es-') || 
        voice.lang === 'es' ||
        voice.name.toLowerCase().includes('spanish') ||
        voice.name.toLowerCase().includes('espaÃ±ol')
    );
    
    if (spanishVoice) {
        utterance.voice = spanishVoice;
        utterance.lang = spanishVoice.lang;
        console.log('ðŸŽ™ï¸ Usando voz:', spanishVoice.name);
    } else {
        utterance.lang = 'es-ES';
    }
    
    // Configurar propiedades de la voz
    utterance.rate = options.rate || 1.0;
    utterance.pitch = options.pitch || 1.0;
    utterance.volume = options.volume || 1.0;
    
    // Eventos de la voz
    utterance.onstart = () => {
        isSpeaking = true;
        document.body.classList.add('is-speaking');
        console.log('ðŸ”Š Iniciando lectura:', text.substring(0, 50) + '...');
    };
    
    utterance.onend = () => {
        isSpeaking = false;
        document.body.classList.remove('is-speaking');
        console.log('âœ… Lectura completada');
    };
    
    utterance.onerror = (event) => {
        isSpeaking = false;
        document.body.classList.remove('is-speaking');
        console.error('âŒ Error en la lectura:', event.error);
        
        // Reintentar si hay error
        if (event.error === 'interrupted' || event.error === 'canceled') {
            setTimeout(() => {
                window.speechSynthesis.speak(utterance);
            }, 100);
        }
    };
    
    // Hablar con delay para evitar problemas
    setTimeout(() => {
        window.speechSynthesis.speak(utterance);
    }, 50);
}

// FunciÃ³n para obtener texto limpio de un elemento
function getCleanText(element) {
    if (!element) return '';
    
    // Clonar el elemento para no afectar el DOM original
    const clone = element.cloneNode(true);
    
    // Eliminar elementos que no queremos leer
    const unwantedElements = clone.querySelectorAll('script, style, svg, iframe');
    unwantedElements.forEach(el => el.remove());
    
    // Obtener texto y limpiarlo
    let text = clone.textContent || clone.innerText || '';
    
    // Limpiar espacios excesivos y caracteres especiales
    text = text.replace(/\s+/g, ' ').trim();
    text = text.replace(/[^\w\s\.\,\;\:\!\?\-\(\)]/g, '');
    
    return text;
}

// FunciÃ³n para activar el lector de voz
async function enableVoiceReader() {
    isVoiceReaderEnabled = true;
    document.body.classList.add('voice-reader-enabled');
    
    // Inicializar voces
    try {
        const voices = await initializeVoices();
        console.log('ðŸŽ™ï¸ Voces disponibles:', voices.length);
        const spanishVoices = voices.filter(v => v.lang.startsWith('es'));
        console.log('ðŸŽ™ï¸ Voces en espaÃ±ol:', spanishVoices.map(v => v.name));
    } catch (error) {
        console.error('Error al cargar voces:', error);
    }
    
    // Agregar eventos de clic para lectura automÃ¡tica
    addVoiceReaderEvents();
    
    // Crear indicador de ayuda flotante
    createVoiceHelpIndicator();
    
    // Mensaje de bienvenida
    setTimeout(() => {
        speakText('Lector de voz activado. Pasa el cursor sobre los elementos para escuchar su contenido, o presiona la tecla R para leer toda la pantalla.');
    }, 800);
    
    // Agregar listener para teclas de acceso rÃ¡pido
    document.addEventListener('keydown', handleVoiceReaderKeyboard);
    
    console.log('ðŸŽ¤ Lector de voz habilitado');
}

// FunciÃ³n para desactivar el lector de voz
function disableVoiceReader() {
    isVoiceReaderEnabled = false;
    document.body.classList.remove('voice-reader-enabled');
    
    // Detener cualquier lectura en curso
    if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
    }
    
    // Remover eventos de lectura automÃ¡tica
    removeVoiceReaderEvents();
    
    // Remover listener de teclado
    document.removeEventListener('keydown', handleVoiceReaderKeyboard);
    
    // Remover indicador de ayuda
    removeVoiceHelpIndicator();
    
    console.log('ðŸ”‡ Lector de voz deshabilitado');
}

// FunciÃ³n para agregar eventos de lectura
function addVoiceReaderEvents() {
    // Leer tÃ­tulos al hacer hover
    const headings = document.querySelectorAll('h1, h2, h3, .map-title, .community-title, .post-title');
    headings.forEach(heading => {
        heading.addEventListener('mouseenter', handleHeadingHover);
        heading.addEventListener('focus', handleHeadingHover);
        heading.style.cursor = 'help';
        heading.setAttribute('tabindex', '0'); // Hacer focusable
    });
    
    // Leer contenido de tarjetas al hacer clic
    const cards = document.querySelectorAll('.cultural-card, .event-card, .list-item, .card');
    cards.forEach(card => {
        card.addEventListener('click', handleCardClick);
        card.addEventListener('focus', handleCardClick);
        card.setAttribute('tabindex', '0'); // Hacer focusable
    });
    
    // Leer botones al hacer hover
    const buttons = document.querySelectorAll('button, .btn, .region-filter, .filter-btn');
    buttons.forEach(button => {
        button.addEventListener('mouseenter', handleButtonHover);
        button.addEventListener('focus', handleButtonHover);
    });
    
    // Leer texto de navegaciÃ³n
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        item.addEventListener('mouseenter', handleNavItemHover);
        item.addEventListener('focus', handleNavItemHover);
    });
    
    // Leer posts de comunidad
    const postCards = document.querySelectorAll('.post-card');
    postCards.forEach(card => {
        card.addEventListener('mouseenter', handlePostCardHover);
        card.addEventListener('focus', handlePostCardHover);
    });
    
    // Leer badges de regiÃ³n
    const badges = document.querySelectorAll('.region-badge, .badge');
    badges.forEach(badge => {
        badge.addEventListener('mouseenter', handleRegionBadgeHover);
        badge.addEventListener('focus', handleRegionBadgeHover);
    });
    
    // Leer inputs y campos de texto al hacer focus
    const inputs = document.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
        input.addEventListener('focus', handleInputFocus);
    });
    
    console.log('ðŸŽ¯ Eventos de lectura agregados a', 
        headings.length + cards.length + buttons.length + navItems.length + postCards.length + badges.length + inputs.length, 
        'elementos');
}

// FunciÃ³n para remover eventos de lectura
function removeVoiceReaderEvents() {
    const headings = document.querySelectorAll('h1, h2, h3, .map-title, .community-title, .post-title');
    headings.forEach(heading => {
        heading.removeEventListener('mouseenter', handleHeadingHover);
        heading.removeEventListener('focus', handleHeadingHover);
        heading.style.cursor = '';
        heading.removeAttribute('tabindex');
    });
    
    const cards = document.querySelectorAll('.cultural-card, .event-card, .list-item, .card');
    cards.forEach(card => {
        card.removeEventListener('click', handleCardClick);
        card.removeEventListener('focus', handleCardClick);
        card.removeAttribute('tabindex');
    });
    
    const buttons = document.querySelectorAll('button, .btn, .region-filter, .filter-btn');
    buttons.forEach(button => {
        button.removeEventListener('mouseenter', handleButtonHover);
        button.removeEventListener('focus', handleButtonHover);
    });
    
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        item.removeEventListener('mouseenter', handleNavItemHover);
        item.removeEventListener('focus', handleNavItemHover);
    });
    
    const postCards = document.querySelectorAll('.post-card');
    postCards.forEach(card => {
        card.removeEventListener('mouseenter', handlePostCardHover);
        card.removeEventListener('focus', handlePostCardHover);
    });
    
    const badges = document.querySelectorAll('.region-badge, .badge');
    badges.forEach(badge => {
        badge.removeEventListener('mouseenter', handleRegionBadgeHover);
        badge.removeEventListener('focus', handleRegionBadgeHover);
    });
    
    const inputs = document.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
        input.removeEventListener('focus', handleInputFocus);
    });
}

// Handlers de eventos
function handleHeadingHover(event) {
    if (!isVoiceReaderEnabled || isSpeaking) return;
    const text = getCleanText(event.target);
    if (text.length > 0 && text.length < 300) {
        speakText(text);
    }
}

function handleCardClick(event) {
    if (!isVoiceReaderEnabled) return;
    
    // Prevenir mÃºltiples lecturas
    event.stopPropagation();
    
    // Obtener informaciÃ³n de la tarjeta
    const title = event.currentTarget.querySelector('h3, .card-info h3')?.textContent || '';
    const location = event.currentTarget.querySelector('.card-location, .list-item-description')?.textContent || '';
    const type = event.currentTarget.querySelector('.card-type')?.textContent || '';
    const access = event.currentTarget.querySelector('.card-access')?.textContent || '';
    
    let text = '';
    if (title) text += title + '. ';
    if (location) text += location + '. ';
    if (type) text += type + '. ';
    if (access) text += access + '.';
    
    if (text.trim()) {
        speakText(text.trim());
    }
}

function handleButtonHover(event) {
    if (!isVoiceReaderEnabled || isSpeaking) return;
    const text = getCleanText(event.target);
    if (text.length > 0 && text.length < 100) {
        speakText(text);
    }
}

function handleNavItemHover(event) {
    if (!isVoiceReaderEnabled || isSpeaking) return;
    const text = getCleanText(event.target);
    if (text.length > 0 && text.length < 100) {
        speakText(text);
    }
}

function handlePostCardHover(event) {
    if (!isVoiceReaderEnabled || isSpeaking) return;
    const title = event.currentTarget.querySelector('.post-title')?.textContent || '';
    if (title) {
        speakText(title);
    }
}

function handleRegionBadgeHover(event) {
    if (!isVoiceReaderEnabled || isSpeaking) return;
    const text = getCleanText(event.target);
    if (text) {
        speakText(text);
    }
}

function handleInputFocus(event) {
    if (!isVoiceReaderEnabled || isSpeaking) return;
    
    const input = event.target;
    const label = input.getAttribute('placeholder') || 
                  input.getAttribute('aria-label') || 
                  input.name || 
                  'Campo de entrada';
    
    const type = input.type;
    let announcement = '';
    
    if (type === 'text' || type === 'email' || type === 'password') {
        announcement = `${label}. Campo de texto`;
    } else if (type === 'checkbox') {
        announcement = `${label}. Casilla de verificaciÃ³n ${input.checked ? 'marcada' : 'desmarcada'}`;
    } else if (input.tagName === 'SELECT') {
        announcement = `${label}. Lista desplegable`;
    } else if (input.tagName === 'TEXTAREA') {
        announcement = `${label}. Ãrea de texto`;
    } else {
        announcement = label;
    }
    
    speakText(announcement);
}

// Handler para teclado
function handleVoiceReaderKeyboard(event) {
    if (!isVoiceReaderEnabled) return;
    
    // Tecla R: Leer toda la pantalla actual
    if (event.key === 'r' || event.key === 'R') {
        event.preventDefault();
        readCurrentScreen();
    }
    
    // Tecla S: Detener lectura
    if (event.key === 's' || event.key === 'S') {
        event.preventDefault();
        stopReading();
    }
    
    // Tecla Escape: Detener lectura
    if (event.key === 'Escape') {
        stopReading();
    }
}

// FunciÃ³n para leer la pantalla actual
function readCurrentScreen() {
    // Obtener la pantalla activa
    const activeScreen = document.querySelector('.screen.active');
    if (!activeScreen) return;
    
    // Obtener el tÃ­tulo principal
    const mainTitle = activeScreen.querySelector('h1, .login-title, .map-title, .community-title');
    const mainText = mainTitle ? getCleanText(mainTitle) : '';
    
    // Obtener descripciÃ³n si existe
    const description = activeScreen.querySelector('.login-subtitle, .map-subtitle, p');
    const descText = description ? getCleanText(description) : '';
    
    // Construir el texto completo
    let fullText = '';
    if (mainText) fullText += mainText + '. ';
    if (descText) fullText += descText + '. ';
    
    // Agregar informaciÃ³n de elementos interactivos
    const buttons = activeScreen.querySelectorAll('button:not(.back-btn):not(.social-btn)');
    if (buttons.length > 0) {
        fullText += `Hay ${buttons.length} botones disponibles. `;
    }
    
    if (fullText) {
        speakText(fullText);
    }
}

// FunciÃ³n para detener la lectura
function stopReading() {
    if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
        isSpeaking = false;
        document.body.classList.remove('is-speaking');
        console.log('â¹ï¸ Lectura detenida');
    }
}

// FunciÃ³n para leer un elemento especÃ­fico (Ãºtil para clicks)
function readElement(element) {
    if (!isVoiceReaderEnabled || !element) return;
    
    const text = getCleanText(element);
    if (text && text.length > 0) {
        speakText(text);
    }
}

// FunciÃ³n para crear indicador de ayuda flotante
function createVoiceHelpIndicator() {
    // Verificar si ya existe
    if (document.querySelector('.voice-help-indicator')) {
        return;
    }
    
    const indicator = document.createElement('div');
    indicator.className = 'voice-help-indicator';
    indicator.innerHTML = `
        <strong>ðŸ’¡ Ayuda del Lector</strong>
        <p><strong>R</strong>: Leer pantalla completa</p>
        <p><strong>S</strong> o <strong>Esc</strong>: Detener lectura</p>
        <p>Pasa el cursor sobre elementos para escucharlos</p>
    `;
    
    document.body.appendChild(indicator);
    
    // Auto-ocultar despuÃ©s de 10 segundos
    setTimeout(() => {
        if (indicator && indicator.parentNode) {
            indicator.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            indicator.style.opacity = '0';
            indicator.style.transform = 'translateY(20px)';
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.remove();
                }
            }, 500);
        }
    }, 10000);
}

// FunciÃ³n para remover indicador de ayuda
function removeVoiceHelpIndicator() {
    const indicator = document.querySelector('.voice-help-indicator');
    if (indicator) {
        indicator.remove();
    }
}

// FunciÃ³n para anunciar el cambio de pantalla
function announceScreen(screenName) {
    if (!isVoiceReaderEnabled) return;
    
    const screenAnnouncements = {
        'login': 'Pantalla de inicio de sesiÃ³n',
        'register': 'Pantalla de registro',
        'home': 'Pantalla principal. Inicio',
        'map': 'Mapa interactivo de eventos culturales',
        'eventDetail': 'Detalles del evento',
        'culture': 'Mi Cultura. Tus estadÃ­sticas y logros',
        'community': 'Comunidad. Publicaciones de otros usuarios'
    };
    
    const announcement = screenAnnouncements[screenName] || `Pantalla de ${screenName}`;
    speakText(announcement);
}

// Cargar configuraciÃ³n guardada al iniciar
document.addEventListener('DOMContentLoaded', function() {
    // Cargar configuraciÃ³n del localStorage
    const savedVoiceReader = localStorage.getItem('voice-reader') === 'true';
    
    // Activar lector de voz si estÃ¡ guardado o si es la primera vez (para demo)
    if (savedVoiceReader || localStorage.getItem('voice-reader') === null) {
        const voiceCheckbox = document.getElementById('voice-reader');
        if (voiceCheckbox) {
            voiceCheckbox.checked = true;
            enableVoiceReader();
            // Guardar la configuraciÃ³n si es la primera vez
            if (localStorage.getItem('voice-reader') === null) {
                localStorage.setItem('voice-reader', 'true');
            }
        }
    }
    
    // Cargar otras configuraciones guardadas
    const savedHighContrast = localStorage.getItem('high-contrast') === 'true';
    const savedLargeFont = localStorage.getItem('large-font') === 'true';
    
    if (savedHighContrast) {
        const contrastCheckbox = document.getElementById('high-contrast');
        if (contrastCheckbox) {
            contrastCheckbox.checked = true;
            document.body.classList.add('high-contrast');
        }
    }
    
    if (savedLargeFont) {
        const fontCheckbox = document.getElementById('large-font');
        if (fontCheckbox) {
            fontCheckbox.checked = true;
            document.documentElement.style.fontSize = '18px';
        }
    }
});    // Update HTML lang attribute
    document.documentElement.lang = currentLanguage;
    
    // Animar el cambio de idioma
    document.body.style.animation = 'fadeIn 0.3s ease-out';
    
    console.log('âœ… PÃ¡gina traducida a:', currentLanguage);
}

// ========================================
// NAVIGATION SYSTEM
// ========================================

// Get all screens
const screens = {
    login: document.getElementById('screen-login'),
    register: document.getElementById('screen-register'),
    home: document.getElementById('screen-home'),
    map: document.getElementById('screen-map'),
    eventDetail: document.getElementById('screen-event-detail'),
    culture: document.getElementById('screen-culture'),
    community: document.getElementById('screen-community')
};

// Show specific screen
function showScreen(screenName) {
    console.log('ðŸ”„ Switching to screen:', screenName);
    
    // Hide all screens
    Object.values(screens).forEach(screen => {
        if (screen) {
            screen.classList.remove('active');
        }
    });
    
    // Show target screen
    if (screens[screenName]) {
        screens[screenName].classList.add('active');
        console.log('âœ… Screen activated:', screenName);
        
        // Initialize map filters when map screen is shown
        if (screenName === 'map') {
            setTimeout(() => {
                if (typeof setupMapFilters === 'function') {
                    setupMapFilters();
                }
            }, 100);
        }
        
        // Leer el tÃ­tulo de la nueva pantalla si el lector de voz estÃ¡ activo
        if (isVoiceReaderEnabled) {
            setTimeout(() => {
                announceScreen(screenName);
                // Re-agregar eventos de lectura para la nueva pantalla
                addVoiceReaderEvents();
            }, 500);
        }
    } else {
        console.error('âŒ Screen not found:', screenName);
    }
    
    // Update bottom navigation
    updateBottomNav(screenName);
    
    // Scroll to top
    window.scrollTo(0, 0);
}

// Update bottom navigation active state
function updateBottomNav(screenName) {
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        item.classList.remove('active');
        
        const itemScreen = item.getAttribute('data-screen');
        if (itemScreen === screenName) {
            item.classList.add('active');
        }
    });
}

// ========================================
// LOGIN SCREEN
// ========================================

// Language buttons
const languageButtons = document.querySelectorAll('.lang-btn');
languageButtons.forEach(button => {
    button.addEventListener('click', function() {
        // Remove active from all
        languageButtons.forEach(btn => btn.classList.remove('active'));
        // Add active to clicked
        this.classList.add('active');
        
        const lang = this.getAttribute('data-lang');
        const langName = this.textContent;
        console.log('ðŸŒ Idioma cambiado a:', lang);
        
        // Change current language
        currentLanguage = lang;
        localStorage.setItem('preferred-language', lang);
        
        // Translate entire page
        translatePage();
        
        // Show notification
        showNotification(`âœ“ Idioma cambiado a ${langName}`);
    });
});

// Accessibility checkboxes
const highContrastCheckbox = document.getElementById('high-contrast');
const voiceReaderCheckbox = document.getElementById('voice-reader');
const largeFontCheckbox = document.getElementById('large-font');

if (highContrastCheckbox) {
    highContrastCheckbox.addEventListener('change', function() {
        if (this.checked) {
            document.body.classList.add('high-contrast');
            console.log('High contrast enabled');
        } else {
            document.body.classList.remove('high-contrast');
            console.log('High contrast disabled');
        }
        localStorage.setItem('high-contrast', this.checked);
    });
}

if (voiceReaderCheckbox) {
    voiceReaderCheckbox.addEventListener('change', function() {
        const isEnabled = this.checked;
        console.log('Voice reader:', isEnabled ? 'enabled' : 'disabled');
        localStorage.setItem('voice-reader', isEnabled);
        
        if (isEnabled) {
            // Activar lector de voz
            enableVoiceReader();
            // Mensaje de confirmaciÃ³n
            speakText('Lector de voz activado. Ahora puedes escuchar el contenido de la pÃ¡gina.');
        } else {
            // Desactivar lector de voz
            disableVoiceReader();
            // Detener cualquier lectura en curso
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
        }
    });
}

if (largeFontCheckbox) {
    largeFontCheckbox.addEventListener('change', function() {
        if (this.checked) {
            document.documentElement.style.fontSize = '18px';
            console.log('Large font enabled');
        } else {
            document.documentElement.style.fontSize = '16px';
            console.log('Large font disabled');
        }
        localStorage.setItem('large-font', this.checked);
    });
}

// Login buttons - Se inicializan despuÃ©s de que showScreen estÃ© disponible
document.addEventListener('DOMContentLoaded', function() {
    const btnSignIn = document.getElementById('btn-signin');
    const btnSignUp = document.getElementById('btn-signup');
    const btnGuest = document.getElementById('btn-guest');

    if (btnSignIn) {
        btnSignIn.addEventListener('click', function() {
            console.log('Sign In clicked');
            // Simulate login and go to home
            showScreen('home');
        });
    }

    if (btnSignUp) {
        btnSignUp.addEventListener('click', function() {
            console.log('Sign Up clicked');
            // Ir a pantalla de registro
            showScreen('register');
        });
    }

    if (btnGuest) {
        btnGuest.addEventListener('click', function() {
            console.log('Explore as Guest clicked');
            // Ir directamente al mapa
            showScreen('map');
            
            // Activar el tab del mapa en la navegaciÃ³n
            setTimeout(() => {
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('data-screen') === 'map') {
                        item.classList.add('active');
                    }
                });
            }, 100);
        });
    }
    
    // Register screen buttons
    const btnBackRegister = document.getElementById('btn-back-register');
    const registerGoogle = document.getElementById('register-google');
    const registerFacebook = document.getElementById('register-facebook');
    const registerApple = document.getElementById('register-apple');
    const emailRegisterForm = document.getElementById('email-register-form');
    const linkToSignin = document.getElementById('link-to-signin');

    if (btnBackRegister) {
        btnBackRegister.addEventListener('click', function() {
            showScreen('login');
        });
    }

    if (registerGoogle) {
        registerGoogle.addEventListener('click', function() {
            console.log('Register with Google clicked');
            // Simular registro exitoso con Google
            alert('Â¡Registro exitoso con Google!');
            showScreen('home');
        });
    }

    if (registerFacebook) {
        registerFacebook.addEventListener('click', function() {
            console.log('Register with Facebook clicked');
            // Simular registro exitoso con Facebook
            alert('Â¡Registro exitoso con Facebook!');
            showScreen('home');
        });
    }

    if (registerApple) {
        registerApple.addEventListener('click', function() {
            console.log('Register with Apple clicked');
            // Simular registro exitoso con Apple
            alert('Â¡Registro exitoso con Apple!');
            showScreen('home');
        });
    }

    if (emailRegisterForm) {
        emailRegisterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            console.log('Email registration:', { name, email, password });
            
            // Simular registro exitoso
            alert(`Â¡Bienvenido ${name}! Tu cuenta ha sido creada exitosamente.`);
            showScreen('home');
        });
    }

    if (linkToSignin) {
        linkToSignin.addEventListener('click', function(e) {
            e.preventDefault();
            showScreen('login');
        });
    }
});

// ========================================
// HOME SCREEN
// ========================================

// Search functionality
const searchInput = document.querySelector('.search-bar input');
if (searchInput) {
    searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        console.log('Searching for:', searchTerm);
        
        // Here you would implement actual search filtering
        // For demo, just log
    });
}

// Filter buttons
const filterButtons = document.querySelectorAll('.filter-btn');
filterButtons.forEach(button => {
    button.addEventListener('click', function() {
        console.log('Filter clicked:', this.textContent);
        
        // Toggle active state
        this.classList.toggle('active');
        
        // Here you would implement actual filtering
    });
});

// Event cards - click to show detail
const eventCards = document.querySelectorAll('.event-card');
eventCards.forEach(card => {
    card.addEventListener('click', function() {
        console.log('Event card clicked');
        showScreen('eventDetail');
    });
});

// List items - click to show detail
const listItems = document.querySelectorAll('.list-item');
listItems.forEach(item => {
    item.addEventListener('click', function() {
        console.log('List item clicked');
        showScreen('eventDetail');
    });
});

// ========================================
// EVENT DETAIL SCREEN
// ========================================

// Back button
const backButtons = document.querySelectorAll('.back-btn');
backButtons.forEach(button => {
    button.addEventListener('click', function() {
        console.log('Back button clicked');
        showScreen('home');
    });
});

// Share button
const shareButtons = document.querySelectorAll('.share-btn');
shareButtons.forEach(button => {
    button.addEventListener('click', function() {
        console.log('Share button clicked');
        
        // Use Web Share API if available
        if (navigator.share) {
            navigator.share({
                title: 'Festival de la Marinera',
                text: 'Mira este evento cultural increÃ­ble',
                url: window.location.href
            }).then(() => {
                console.log('Successfully shared');
            }).catch((error) => {
                console.log('Error sharing:', error);
            });
        } else {
            // Fallback: copy to clipboard
            alert('Link copiado al portapapeles');
        }
    });
});

// Recommendation cards
const recommendationCards = document.querySelectorAll('.recommendation-card');
recommendationCards.forEach(card => {
    card.addEventListener('click', function() {
        console.log('Recommendation clicked');
        // Could navigate to another event detail
    });
});

// ========================================
// BOTTOM NAVIGATION
// ========================================

// Bottom nav items
const navItems = document.querySelectorAll('.nav-item');
navItems.forEach(item => {
    item.addEventListener('click', function() {
        const targetScreen = this.getAttribute('data-screen');
        console.log('Nav item clicked:', targetScreen);
        
        if (targetScreen) {
            showScreen(targetScreen);
        }
    });
});

// ========================================
// COMMUNITY SCREEN
// ========================================

// FAB (Floating Action Button)
const fab = document.querySelector('.fab');
if (fab) {
    fab.addEventListener('click', function() {
        console.log('Create publication clicked');
        alert('Funcionalidad de crear publicaciÃ³n');
        // Here you would show a modal or form to create a post
    });
}

// Post cards
const postCards = document.querySelectorAll('.post-card');
postCards.forEach(card => {
    card.addEventListener('click', function() {
        console.log('Post card clicked');
        // Could show post detail or expand
    });
});

// ========================================
// LOAD PREFERENCES
// ========================================

function showNotification(message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-100px);
        background: linear-gradient(135deg, #06D6A0 0%, #00B4D8 100%);
        color: white;
        padding: 16px 32px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2), 0 0 40px rgba(6, 214, 160, 0.4);
        z-index: 10000;
        font-weight: 700;
        font-size: 16px;
        animation: slideDownNotif 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        display: flex;
        align-items: center;
        gap: 12px;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Add keyframes for animation
    if (!document.getElementById('notif-styles')) {
        const style = document.createElement('style');
        style.id = 'notif-styles';
        style.textContent = `
            @keyframes slideDownNotif {
                0% {
                    transform: translateX(-50%) translateY(-100px);
                    opacity: 0;
                }
                100% {
                    transform: translateX(-50%) translateY(0);
                    opacity: 1;
                }
            }
            @keyframes slideUpNotif {
                0% {
                    transform: translateX(-50%) translateY(0);
                    opacity: 1;
                }
                100% {
                    transform: translateX(-50%) translateY(-100px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideUpNotif 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards';
        setTimeout(() => notification.remove(), 400);
    }, 3000);
}

function loadPreferences() {
    // Load language
    const savedLang = localStorage.getItem('preferred-language');
    if (savedLang) {
        currentLanguage = savedLang;
        const langBtn = document.querySelector(`.lang-btn[data-lang="${savedLang}"]`);
        if (langBtn) {
            languageButtons.forEach(btn => btn.classList.remove('active'));
            langBtn.classList.add('active');
        }
    }
    
    // Translate page
    translatePage();
    
    // Load high contrast
    const savedHighContrast = localStorage.getItem('high-contrast') === 'true';
    if (savedHighContrast && highContrastCheckbox) {
        highContrastCheckbox.checked = true;
        document.body.classList.add('high-contrast');
    }
    
    // Load voice reader
    const savedVoiceReader = localStorage.getItem('voice-reader') === 'true';
    if (savedVoiceReader && voiceReaderCheckbox) {
        voiceReaderCheckbox.checked = true;
    }
    
    // Load large font
    const savedLargeFont = localStorage.getItem('large-font') === 'true';
    if (savedLargeFont && largeFontCheckbox) {
        largeFontCheckbox.checked = true;
        document.documentElement.style.fontSize = '18px';
    }
}

// ========================================
// SMOOTH SCROLL
// ========================================

// Smooth scroll for anchor links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    });
});

// ========================================
// LAZY LOADING IMAGES
// ========================================

if ('IntersectionObserver' in window) {
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                if (img.dataset.src) {
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                }
                observer.unobserve(img);
            }
        });
    });
    
    // Observe all images with data-src
    document.querySelectorAll('img[data-src]').forEach(img => {
        imageObserver.observe(img);
    });
}

// ========================================
// TOUCH GESTURES (for mobile)
// ========================================

let touchStartX = 0;
let touchEndX = 0;

document.addEventListener('touchstart', e => {
    touchStartX = e.changedTouches[0].screenX;
});

document.addEventListener('touchend', e => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
});

function handleSwipe() {
    const swipeThreshold = 50;
    const diff = touchStartX - touchEndX;
    
    if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) {
            // Swiped left
            console.log('Swiped left');
        } else {
            // Swiped right
            console.log('Swiped right');
        }
    }
}

// ========================================
// OFFLINE DETECTION
// ========================================

window.addEventListener('online', () => {
    console.log('Connection restored');
    // Could show a notification
});

window.addEventListener('offline', () => {
    console.log('Connection lost');
    // Could show a notification
});

// ========================================
// SERVICE WORKER (PWA Support)
// ========================================

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        // Uncomment to enable service worker
        // navigator.serviceWorker.register('/sw.js')
        //     .then(registration => {
        //         console.log('ServiceWorker registered:', registration);
        //     })
        //     .catch(error => {
        //         console.log('ServiceWorker registration failed:', error);
        //     });
    });
}

// ========================================
// ANALYTICS (placeholder)
// ========================================

function trackEvent(category, action, label) {
    console.log('Event tracked:', { category, action, label });
    
    // Here you would send to your analytics service
    // Example: Google Analytics, Mixpanel, etc.
    
    // if (typeof gtag !== 'undefined') {
    //     gtag('event', action, {
    //         'event_category': category,
    //         'event_label': label
    //     });
    // }
}

// Track screen views
function trackScreenView(screenName) {
    console.log('Screen view:', screenName);
    trackEvent('Navigation', 'screen_view', screenName);
}

// ========================================
// INITIALIZE APP
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸŽ¨ Cultura Peruana Accesible - App initialized');
    
    // Load saved preferences
    loadPreferences();
    
    // Check if we need to navigate to a specific screen from map
    const targetScreen = localStorage.getItem('targetScreen');
    if (targetScreen && targetScreen !== 'map') {
        console.log('ðŸŽ¯ Auto-navigating to:', targetScreen);
        localStorage.removeItem('targetScreen'); // Clean up
        setTimeout(() => {
            showScreen(targetScreen);
        }, 500);
    }
    
    // Check if user is logged in (from localStorage)
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
    
    if (isLoggedIn) {
        // Go directly to home
        showScreen('home');
    } else {
        // Show login screen
        showScreen('login');
    }
    
    // Track initial screen
    trackScreenView('app_start');
    
    console.log('âœ… All features loaded successfully');
});

// ========================================
// ERROR HANDLING
// ========================================

window.addEventListener('error', function(e) {
    console.error('Global error:', e.error);
    // Could send to error tracking service like Sentry
});

window.addEventListener('unhandledrejection', function(e) {
    console.error('Unhandled promise rejection:', e.reason);
    // Could send to error tracking service
});

// ========================================
// PERFORMANCE MONITORING
// ========================================

if ('PerformanceObserver' in window) {
    try {
        // Observe Largest Contentful Paint
        const lcpObserver = new PerformanceObserver((list) => {
            const entries = list.getEntries();
            const lastEntry = entries[entries.length - 1];
            console.log('LCP:', lastEntry.renderTime || lastEntry.loadTime);
        });
        lcpObserver.observe({ entryTypes: ['largest-contentful-paint'] });
        
        // Observe First Input Delay
        const fidObserver = new PerformanceObserver((list) => {
            const entries = list.getEntries();
            entries.forEach((entry) => {
                console.log('FID:', entry.processingStart - entry.startTime);
            });
        });
        fidObserver.observe({ entryTypes: ['first-input'] });
        
    } catch (e) {
        console.log('Performance monitoring not supported');
    }
}

// ========================================
// EXPORT FUNCTIONS (for testing)
// ========================================

if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        showScreen,
        trackEvent,
        loadPreferences
    };
}

// ========================================
// DEBUG MODE
// ========================================

// Enable debug mode with console
window.enableDebugMode = function() {
    console.log('ðŸ› Debug mode enabled');
    document.body.classList.add('debug-mode');
    
    // Add click listeners to all elements to show their info
    document.querySelectorAll('*').forEach(el => {
        el.addEventListener('click', function(e) {
            e.stopPropagation();
            console.log('Element clicked:', {
                tag: this.tagName,
                classes: this.className,
                id: this.id,
                text: this.textContent.substring(0, 50)
            });
        }, true);
    });
};

// Disable debug mode
window.disableDebugMode = function() {
    console.log('Debug mode disabled');
    document.body.classList.remove('debug-mode');
    // Remove listeners would require storing references
};

// ========================================
// CULTURAL MAP - FILTERS & SEARCH
// ========================================

// Setup cultural map filters
function setupCulturalMapFilters() {
    const regionFilters = document.querySelectorAll('.region-filter');
    const regionSections = document.querySelectorAll('.region-section');
    const searchInput = document.getElementById('cultural-search-input');
    const culturalCards = document.querySelectorAll('.cultural-card');
    
    // Region filter functionality
    if (regionFilters.length > 0) {
        regionFilters.forEach(filter => {
            filter.addEventListener('click', () => {
                // Remove active class from all
                regionFilters.forEach(f => f.classList.remove('active'));
                // Add active to clicked
                filter.classList.add('active');
                
                const selectedRegion = filter.getAttribute('data-region');
                console.log('ðŸ“ Region selected:', selectedRegion);
                
                // Show/hide sections
                regionSections.forEach(section => {
                    const sectionRegion = section.getAttribute('data-region');
                    if (selectedRegion === 'all' || sectionRegion === selectedRegion) {
                        section.style.display = 'block';
                        // Animate cards in
                        const cards = section.querySelectorAll('.cultural-card');
                        cards.forEach((card, index) => {
                            card.style.animation = `fadeIn 0.4s ease-out ${index * 0.1}s both`;
                        });
                    } else {
                        section.style.display = 'none';
                    }
                });
            });
        });
    }
    
    // Search functionality
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            console.log('ðŸ” Searching for:', searchTerm);
            
            let visibleCount = 0;
            
            culturalCards.forEach(card => {
                const title = card.querySelector('h3')?.textContent.toLowerCase() || '';
                const location = card.querySelector('.card-location')?.textContent.toLowerCase() || '';
                const type = card.querySelector('.card-type')?.textContent.toLowerCase() || '';
                
                if (title.includes(searchTerm) || location.includes(searchTerm) || type.includes(searchTerm) || searchTerm === '') {
                    card.style.display = 'flex';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Show all regions when searching
            if (searchTerm !== '') {
                regionSections.forEach(section => {
                    section.style.display = 'block';
                });
            }
            
            console.log(`âœ… ${visibleCount} lugares encontrados`);
        });
    }
    
    // Add click handlers to cultural cards
    culturalCards.forEach(card => {
        card.addEventListener('click', () => {
            const title = card.querySelector('h3')?.textContent || '';
            const location = card.querySelector('.card-location')?.textContent || '';
            console.log('ðŸ“Œ Selected:', title);
            
            // Show detail modal or navigate
            showCulturalPlaceDetail(title, location);
        });
    });
}

// Show cultural place detail
function showCulturalPlaceDetail(title, location) {
    // Simple alert for now - can be enhanced with modal
    const message = `ðŸ›ï¸ ${title}\n\nðŸ“ ${location}\n\nâœ¨ Â¡Descubre mÃ¡s sobre este lugar cultural!`;
    alert(message);
}

console.log('ðŸ’¡ Tip: Run enableDebugMode() in console to debug');

// ========================================
// CHECK LEAFLET AVAILABILITY
// ========================================

// Check if Leaflet is loaded when script executes
window.addEventListener('DOMContentLoaded', () => {
    if (typeof L !== 'undefined') {
        console.log('âœ… Leaflet library loaded successfully!');
        console.log('Leaflet version:', L.version);
    } else {
        console.error('âŒ Leaflet library NOT loaded!');
        console.error('Check if internet connection is available');
        console.error('Check browser console for network errors');
    }
});

// ========================================
// INTERACTIVE MAP WITH LEAFLET
// ========================================

let map;
let markers = [];

// Cultural places data - Lugares culturales de Lima
const culturalPlaces = [
    {
        name: "Museo Nacional de ArqueologÃ­a, AntropologÃ­a e Historia del PerÃº",
        address: "Av. Javier Prado Este 2465, San Borja, Lima",
        lat: -12.0864,
        lng: -77.0028,
        type: "museum",
        icon: "ðŸ›ï¸",
        color: "#4895EF"
    },
    {
        name: "Museo Larco",
        address: "Av. BolÃ­var 1515, Pueblo Libre, Lima",
        lat: -12.0753,
        lng: -77.0730,
        type: "museum",
        icon: "ðŸº",
        color: "#9D4EDD"
    },
    {
        name: "Centro HistÃ³rico de Lima",
        address: "Plaza Mayor, Lima",
        lat: -12.0464,
        lng: -77.0428,
        type: "heritage",
        icon: "ðŸ°",
        color: "#FF9500"
    },
    {
        name: "Huaca Pucllana",
        address: "Calle General BorgoÃ±o cuadra 8, Miraflores, Lima",
        lat: -12.1078,
        lng: -77.0311,
        type: "heritage",
        icon: "â›°ï¸",
        color: "#D91E3A"
    },
    {
        name: "Museo de Arte de Lima (MALI)",
        address: "Paseo ColÃ³n 125, Lima",
        lat: -12.0686,
        lng: -77.0362,
        type: "museum",
        icon: "ðŸŽ¨",
        color: "#06D6A0"
    },
    {
        name: "Circuito MÃ¡gico del Agua",
        address: "Parque de la Reserva, Lima",
        lat: -12.0700,
        lng: -77.0364,
        type: "activity",
        icon: "â›²",
        color: "#00B4D8"
    },
    {
        name: "Museo Pedro de Osma",
        address: "Av. Pedro de Osma 423, Barranco, Lima",
        lat: -12.1461,
        lng: -77.0197,
        type: "museum",
        icon: "ðŸ–¼ï¸",
        color: "#FFC857"
    },
    {
        name: "Santuario ArqueolÃ³gico de Pachacamac",
        address: "Antigua Carretera Panamericana Sur Km 31.5, LurÃ­n, Lima",
        lat: -12.2667,
        lng: -76.9042,
        type: "heritage",
        icon: "ðŸŒ¾",
        color: "#FF6B6B"
    }
];

// Initialize map when map screen becomes active
function initializeMap() {
    if (map) {
        console.log('Map already initialized');
        return; // Already initialized
    }
    
    console.log('ðŸ—ºï¸ Initializing map...');
    
    // Check if Leaflet is loaded
    if (typeof L === 'undefined') {
        console.error('âŒ Leaflet library not loaded!');
        return;
    }
    
    // Check if map container exists
    const mapContainer = document.getElementById('map');
    if (!mapContainer) {
        console.error('âŒ Map container not found!');
        return;
    }
    
    console.log('âœ… Map container found:', mapContainer);
    
    // Create map centered on Lima, Peru
    try {
        map = L.map('map', {
            scrollWheelZoom: false,  // Disable scroll zoom by default
            dragging: true,
            touchZoom: true,
            doubleClickZoom: true,
            boxZoom: true,
            keyboard: true,
            zoomControl: true
        }).setView([-12.1200, -77.0350], 12);
        console.log('âœ… Map object created');
        
        // Enable scroll zoom only when map is focused
        // Enable scroll zoom after a short delay to prevent focus issues
        setTimeout(() => {
            map.on('click', () => {
                map.scrollWheelZoom.enable();
                setTimeout(() => {
                    map.scrollWheelZoom.disable();
                }, 3000);
            });
        }, 500);
        
    } catch (error) {
        console.error('âŒ Error creating map:', error);
        return;
    }
    
    // Add OpenStreetMap tile layer
    try {
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        console.log('âœ… Tile layer added');
    } catch (error) {
        console.error('âŒ Error adding tile layer:', error);
        return;
    }
    
    // Add markers for cultural places with custom colors
    culturalPlaces.forEach(place => {
        // Use the color from the place data
        const color = place.color || '#D91E3A';
        
        // Create custom pin-shaped marker
        const customIcon = L.divIcon({
            className: 'custom-marker',
            html: `
                <div style="
                    position: relative;
                    width: 36px;
                    height: 36px;
                ">
                    <div style="
                        background: ${color};
                        width: 36px;
                        height: 36px;
                        border-radius: 50% 50% 50% 0;
                        transform: rotate(-45deg);
                        border: 3px solid white;
                        box-shadow: 0 3px 10px rgba(0,0,0,0.4);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">
                        <span style="
                            transform: rotate(45deg);
                            font-size: 18px;
                            margin-bottom: 4px;
                            margin-right: 2px;
                        ">${place.icon}</span>
                    </div>
                </div>
            `,
            iconSize: [36, 36],
            iconAnchor: [18, 36],
            popupAnchor: [0, -36]
        });
        
        const marker = L.marker([place.lat, place.lng], { icon: customIcon }).addTo(map);
        
        // Create popup content with better styling
        const popupContent = `
            <div style="min-width: 220px; font-family: 'Inter', sans-serif;">
                <div style="
                    font-size: 28px; 
                    margin-bottom: 10px;
                    text-align: center;
                ">${place.icon}</div>
                <h3 style="
                    margin: 0 0 8px 0; 
                    font-size: 15px; 
                    font-weight: 700; 
                    color: #1A1A2E;
                    line-height: 1.3;
                ">${place.name}</h3>
                <p style="
                    margin: 0 0 12px 0; 
                    font-size: 13px; 
                    color: #6B6B84;
                    line-height: 1.4;
                ">${place.address}</p>
                <button onclick="showPlaceDetails('${place.name.replace(/'/g, "\\'")}')" style="
                    background: ${place.color};
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 10px;
                    font-size: 13px;
                    cursor: pointer;
                    font-weight: 600;
                    width: 100%;
                    transition: all 0.3s;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                ">Ver detalles</button>
            </div>
        `;
        
        marker.bindPopup(popupContent);
        markers.push(marker);
    });
    
    console.log(`âœ… Map initialized with ${markers.length} markers`);
    
    // Adjust map bounds to show all markers
    if (markers.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1)); // Add 10% padding
        console.log('âœ… Map bounds adjusted to show all markers');
    }
    
    // Add info control to map
    const info = L.control({ position: 'topright' });
    info.onAdd = function() {
        const div = L.DomUtil.create('div', 'map-info-control');
        div.innerHTML = '<small style="background: white; padding: 4px 8px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: block;">ðŸ’¡ Click para hacer zoom</small>';
        return div;
    };
    info.addTo(map);
    
    // Force map to resize properly
    setTimeout(() => {
        map.invalidateSize();
        console.log('âœ… Map size invalidated');
    }, 100);
}

// Show place details function
window.showPlaceDetails = function(placeName) {
    alert(`Mostrando detalles de: ${placeName}`);
};

// Map search functionality
function setupMapSearch() {
    const mapSearchInput = document.querySelector('.map-search-overlay input');
    const placeCards = document.querySelectorAll('.map-places-list .place-card');
    
    if (mapSearchInput) {
        mapSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            
            // Filter markers on map
            markers.forEach((marker, index) => {
                const place = culturalPlaces[index];
                const matchesSearch = place.name.toLowerCase().includes(searchTerm) || 
                                     place.address.toLowerCase().includes(searchTerm);
                
                if (matchesSearch || searchTerm === '') {
                    marker.setOpacity(1);
                } else {
                    marker.setOpacity(0.3);
                }
            });
            
            // Filter place cards in list
            placeCards.forEach(card => {
                const title = card.querySelector('.place-card-title')?.textContent.toLowerCase() || '';
                const address = card.querySelector('.place-card-address')?.textContent.toLowerCase() || '';
                
                if (title.includes(searchTerm) || address.includes(searchTerm) || searchTerm === '') {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    }
}

// Location button functionality
function setupLocationButton() {
    const locationBtn = document.querySelector('.location-btn');
    if (locationBtn) {
        locationBtn.addEventListener('click', () => {
            if (map) {
                map.setView([-12.0464, -77.0328], 13);
            }
        });
    }
}

// Setup place card clicks to center map on location
function setupPlaceCardClicks() {
    const placeCards = document.querySelectorAll('.map-places-list .place-card');
    placeCards.forEach((card, index) => {
        const btn = card.querySelector('.place-card-btn');
        if (btn && index < culturalPlaces.length) {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const place = culturalPlaces[index];
                if (map && markers[index]) {
                    map.setView([place.lat, place.lng], 16);
                    markers[index].openPopup();
                    // Scroll to top to see the map
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });
        }
    });
}

// ========================================
// MAP SCREEN FUNCTIONALITY
// ========================================

// Filtrado por regiÃ³n en el mapa cultural
function setupMapFilters() {
    // Nuevos botones modernos
    const modernFilterButtons = document.querySelectorAll('.region-btn');
    const modernRegionSections = document.querySelectorAll('.region-section-modern');
    
    // Botones antiguos (por compatibilidad)
    const filterButtons = document.querySelectorAll('.region-filter');
    const regionSections = document.querySelectorAll('.region-section');
    
    const searchInput = document.getElementById('cultural-search-input');
    const culturalCards = document.querySelectorAll('.cultural-card');
    const placeCardsModern = document.querySelectorAll('.place-card-modern');

    // Filtros modernos
    if (modernFilterButtons.length > 0) {
        modernFilterButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active from all buttons
                modernFilterButtons.forEach(btn => btn.classList.remove('active'));
                
                // Add active to clicked button
                button.classList.add('active');
                
                // Get selected region
                const selectedRegion = button.getAttribute('data-region');
                
                // Filter modern sections
                modernRegionSections.forEach(section => {
                    const sectionRegion = section.getAttribute('data-region');
                    
                    if (selectedRegion === 'all') {
                        section.style.display = 'block';
                        section.style.animation = 'fadeInUp 0.6s ease-out';
                    } else {
                        if (sectionRegion === selectedRegion) {
                            section.style.display = 'block';
                            section.style.animation = 'fadeInUp 0.6s ease-out';
                        } else {
                            section.style.display = 'none';
                        }
                    }
                });
            });
        });
    }

    // Filtros de regiÃ³n antiguos (compatibilidad)
    if (filterButtons.length > 0) {
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active from all buttons
                filterButtons.forEach(btn => btn.classList.remove('active'));
                
                // Add active to clicked button
                button.classList.add('active');
                
                // Get selected region
                const selectedRegion = button.getAttribute('data-region');
                
                // Filter sections
                regionSections.forEach(section => {
                    const sectionRegion = section.getAttribute('data-region');
                    
                    if (selectedRegion === 'all') {
                        section.style.display = 'block';
                        section.style.animation = 'fadeInUp 0.6s ease-out';
                    } else {
                        if (sectionRegion === selectedRegion) {
                            section.style.display = 'block';
                            section.style.animation = 'fadeInUp 0.6s ease-out';
                        } else {
                            section.style.display = 'none';
                        }
                    }
                });
            });
        });
    }

    // BÃºsqueda en tiempo real
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            
            culturalCards.forEach(card => {
                const title = card.querySelector('h3')?.textContent.toLowerCase() || '';
                const location = card.querySelector('.card-location')?.textContent.toLowerCase() || '';
                const tags = Array.from(card.querySelectorAll('.card-type, .card-access'))
                    .map(tag => tag.textContent.toLowerCase())
                    .join(' ');
                
                const matchesSearch = title.includes(searchTerm) || 
                                     location.includes(searchTerm) || 
                                     tags.includes(searchTerm);
                
                if (matchesSearch) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Show/hide region sections based on visible cards
            regionSections.forEach(section => {
                const visibleCards = Array.from(section.querySelectorAll('.cultural-card'))
                    .filter(card => card.style.display !== 'none');
                
                if (searchTerm === '' || visibleCards.length > 0) {
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
            });
        });
    }

    // AnimaciÃ³n de entrada para las tarjetas modernas
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);

    // Observer para tarjetas modernas
    placeCardsModern.forEach(card => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(card);
    });

    // Observer para tarjetas antiguas
    culturalCards.forEach(card => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(card);
    });
}


/* ========================================
   CÃ“DIGO JAVASCRIPT PARA EL SIDEBAR
   Agregar este cÃ³digo al final del archivo script.js
======================================== */

// Toggle del sidebar del mapa
document.addEventListener('DOMContentLoaded', function() {
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebar = document.getElementById('map-sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    
    if (sidebarToggle && sidebar) {
        // Toggle al hacer clic en el botÃ³n
        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('collapsed');
            
            // En mÃ³vil, mostrar/ocultar overlay
            if (window.innerWidth < 768) {
                sidebarOverlay.classList.toggle('active');
            }
        });
        
        // Cerrar sidebar al hacer clic en el overlay
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', function() {
                sidebar.classList.add('collapsed');
                sidebarOverlay.classList.remove('active');
            });
        }
        
        // Auto-colapsar en pantallas pequeÃ±as al cargar
        if (window.innerWidth < 768) {
            sidebar.classList.add('collapsed');
        }
        
        // Manejar cambios de tamaÃ±o de pantalla
        window.addEventListener('resize', function() {
            if (window.innerWidth >= 768) {
                // En pantallas grandes, ocultar overlay
                sidebarOverlay.classList.remove('active');
            } else {
                // En pantallas pequeÃ±as, colapsar sidebar
                if (!sidebar.classList.contains('collapsed')) {
                    sidebarOverlay.classList.add('active');
                }
            }
        });
    }
});

/* ========================================
   MODAL POPUP PARA INFORMACIÃ“N DE LUGARES
======================================== */

// Datos de los lugares culturales
const placesData = {
    'Museo Nacional de ArqueologÃ­a': {
        icon: 'ðŸ›ï¸',
        description: 'El museo mÃ¡s antiguo y grande del PerÃº, con colecciones que abarcan desde la prehistoria hasta la Ã©poca colonial. Destacan las salas de cerÃ¡mica, textiles y metalurgia.',
        image: 'https://images.unsplash.com/photo-1566127992631-137a642a90f4?w=600&h=400&fit=crop',
        schedule: 'Martes a SÃ¡bado:<br>9:00 - 17:00',
        location: 'San Borja, Lima',
        accessibility: 'Rampas, ascensores, guÃ­as en lenguaje de seÃ±as',
        phone: '+51 1463 5070'
    },
    'Museo Larco': {
        icon: 'ðŸº',
        description: 'Fundado en 1926, alberga la colecciÃ³n mÃ¡s completa de arte precolombino del PerÃº. Destaca su galerÃ­a erÃ³tica y sus jardines con esculturas.',
        image: 'https://images.unsplash.com/photo-1582555172866-f73bb12a2ab3?w=600&h=400&fit=crop',
        schedule: 'Todos los dÃ­as:<br>10:00 - 18:00',
        location: 'Pueblo Libre, Lima',
        accessibility: 'Totalmente accesible, rampas y baÃ±os adaptados',
        phone: '+51 1461 1312'
    },
    'Centro HistÃ³rico': {
        icon: 'ðŸ°',
        description: 'Patrimonio Mundial de la UNESCO desde 1988. Incluye la Plaza Mayor, la Catedral, el Palacio de Gobierno y numerosas iglesias coloniales.',
        image: 'https://images.unsplash.com/photo-1531968455001-5c5272a41129?w=600&h=400&fit=crop',
        schedule: 'Abierto todo el dÃ­a:<br>Visita libre',
        location: 'Cercado de Lima',
        accessibility: 'Parcialmente accesible, calles empedradas',
        phone: 'InformaciÃ³n: +51 1427 6080'
    },
    'Huaca Pucllana': {
        icon: 'â›°ï¸',
        description: 'PirÃ¡mide ceremonial de la cultura Lima (200-700 d.C.). Ofrece visitas guiadas nocturnas y cuenta con un museo de sitio y restaurante.',
        image: 'https://images.unsplash.com/photo-1518509562904-e7ef99cdcc86?w=600&h=400&fit=crop',
        schedule: 'MiÃ©rcoles a Lunes:<br>9:00 - 17:00',
        location: 'Miraflores, Lima',
        accessibility: 'Accesible, senderos adaptados',
        phone: '+51 1617 7148'
    },
    'Museo de Arte de Lima (MALI)': {
        icon: 'ðŸŽ¨',
        description: 'El principal museo de arte del paÃ­s, con colecciones desde la Ã©poca precolombina hasta el arte contemporÃ¡neo peruano.',
        image: 'https://images.unsplash.com/photo-1541961017774-22349e4a1262?w=600&h=400&fit=crop',
        schedule: 'Martes a Domingo:<br>10:00 - 19:00',
        location: 'Paseo ColÃ³n, Lima',
        accessibility: 'Totalmente accesible, ascensores y rampas',
        phone: '+51 1204 0000'
    },
    'Circuito MÃ¡gico del Agua': {
        icon: 'â›²',
        description: 'Complejo de fuentes cibernÃ©ticas reconocido por el Guinness World Records. EspectÃ¡culo nocturno con luces, mÃºsica y agua.',
        image: 'https://images.unsplash.com/photo-1547036967-23d11aacaee0?w=600&h=400&fit=crop',
        schedule: 'MiÃ©rcoles a Domingo:<br>15:00 - 22:30',
        location: 'Parque de la Reserva, Lima',
        accessibility: 'Accesible, senderos pavimentados',
        phone: '+51 1330 1041'
    },
    'Machu Picchu': {
        icon: 'ðŸ”ï¸',
        description: 'Maravilla del Mundo Moderno y Patrimonio de la Humanidad. Ciudadela inca construida en el siglo XV, redescubierta en 1911.',
        image: 'https://images.unsplash.com/photo-1587595431973-160d0d94add1?w=600&h=400&fit=crop',
        schedule: 'Todos los dÃ­as:<br>6:00 - 17:30',
        location: 'Urubamba, Cusco',
        accessibility: 'Acceso limitado, terreno irregular',
        phone: 'Reservas: +51 84211196'
    },
    'SacsayhuamÃ¡n': {
        icon: 'ðŸ›ï¸',
        description: 'Fortaleza ceremonial inca con enormes bloques de piedra. Sitio del Inti Raymi, la fiesta del sol que se celebra cada 24 de junio.',
        image: 'https://images.unsplash.com/photo-1526392060635-9d6019884377?w=600&h=400&fit=crop',
        schedule: 'Todos los dÃ­as:<br>7:00 - 18:00',
        location: 'Cusco',
        accessibility: 'Parcialmente accesible, caminos empinados',
        phone: '+51 84582030'
    },
    'Museo de Arte Precolombino': {
        icon: 'ðŸŽ­',
        description: 'Exhibe 450 obras maestras de culturas preincas e inca. Ubicado en una casona colonial restaurada del siglo XVI.',
        image: 'https://images.unsplash.com/photo-1595433707802-6b2626ef1c91?w=600&h=400&fit=crop',
        schedule: 'Todos los dÃ­as:<br>9:00 - 22:00',
        location: 'Plaza Nazarenas, Cusco',
        accessibility: 'Accesible, instalaciones adaptadas',
        phone: '+51 84233210'
    }
};

// FunciÃ³n para abrir el modal
function openPlaceModal(placeName) {
    const modal = document.getElementById('place-modal');
    const data = placesData[placeName];
    
    if (!modal || !data) return;
    
    // Actualizar contenido del modal
    document.getElementById('modal-icon').textContent = data.icon;
    document.getElementById('modal-title').textContent = placeName;
    document.getElementById('modal-description').textContent = data.description;
    document.getElementById('modal-image').innerHTML = `<img src="${data.image}" alt="${placeName}">`;
    document.getElementById('modal-schedule').innerHTML = data.schedule;
    document.getElementById('modal-location').textContent = data.location;
    document.getElementById('modal-accessibility').textContent = data.accessibility;
    document.getElementById('modal-phone').textContent = data.phone;
    
    // Mostrar modal
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

// FunciÃ³n para cerrar el modal
function closePlaceModal() {
    const modal = document.getElementById('place-modal');
    if (!modal) return;
    
    modal.classList.remove('active');
    document.body.style.overflow = '';
}

// Inicializar eventos del modal
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('place-modal');
    const modalClose = document.getElementById('modal-close');
    const modalOverlay = modal?.querySelector('.modal-overlay');
    
    // Cerrar al hacer clic en el botÃ³n X
    if (modalClose) {
        modalClose.addEventListener('click', closePlaceModal);
    }
    
    // Cerrar al hacer clic en el overlay
    if (modalOverlay) {
        modalOverlay.addEventListener('click', closePlaceModal);
    }
    
    // Cerrar con la tecla ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal?.classList.contains('active')) {
            closePlaceModal();
        }
    });
    
    // Agregar evento click a todas las tarjetas culturales
    const culturalCards = document.querySelectorAll('.cultural-card');
    culturalCards.forEach(card => {
        card.addEventListener('click', function(e) {
            // No abrir modal si se estÃ¡ usando el lector de voz
            if (isVoiceReaderEnabled) return;
            
            const placeName = this.querySelector('h3')?.textContent.trim();
            if (placeName && placesData[placeName]) {
                openPlaceModal(placeName);
            }
        });
    });
    
    // BotÃ³n "Ver en Mapa"
    const directionsBtn = document.getElementById('modal-directions');
    if (directionsBtn) {
        directionsBtn.addEventListener('click', function() {
            const location = document.getElementById('modal-location').textContent;
            const placeName = document.getElementById('modal-title').textContent;
            const searchQuery = encodeURIComponent(`${placeName}, ${location}`);
            window.open(`https://www.google.com/maps/search/?api=1&query=${searchQuery}`, '_blank');
        });
    }
    
    // BotÃ³n "Compartir"
    const shareBtn = document.getElementById('modal-share');
    if (shareBtn) {
        shareBtn.addEventListener('click', function() {
            const placeName = document.getElementById('modal-title').textContent;
            const description = document.getElementById('modal-description').textContent;
            
            if (navigator.share) {
                navigator.share({
                    title: placeName,
                    text: description,
                    url: window.location.href
                }).catch(err => console.log('Error al compartir:', err));
            } else {
                // Fallback: copiar al portapapeles
                const textToCopy = `${placeName}: ${description}`;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    alert('Â¡InformaciÃ³n copiada al portapapeles!');
                });
            }
        });
    }
});

// ========================================
// LECTOR DE VOZ (VOICE READER)
// ========================================

let isVoiceReaderActive = false;
let currentVoice = null;
let isSpeaking = false;
let voiceReaderEnabled = false;

// Inicializar voces
function initializeVoices() {
    return new Promise((resolve) => {
        const voices = window.speechSynthesis.getVoices();
        if (voices.length > 0) {
            resolve(voices);
        } else {
            window.speechSynthesis.onvoiceschanged = () => {
                resolve(window.speechSynthesis.getVoices());
            };
        }
    });
}

// FunciÃ³n para hablar texto
function speakText(text, options = {}) {
    if (!window.speechSynthesis || !isVoiceReaderActive) return;
    
    // Limpiar cualquier speech anterior
    window.speechSynthesis.cancel();
    isSpeaking = false;
    
    // Validar texto
    if (!text || text.trim().length === 0) return;
    
    const utterance = new SpeechSynthesisUtterance(text);
    
    // Configurar voz segÃºn idioma actual
    const voices = window.speechSynthesis.getVoices();
    let voiceLang = 'es-ES';
    
    switch(currentLanguage) {
        case 'en': voiceLang = 'en-US'; break;
        case 'fr': voiceLang = 'fr-FR'; break;
        default: voiceLang = 'es-ES';
    }
    
    const selectedVoice = voices.find(voice => 
        voice.lang.startsWith(voiceLang.split('-')[0]) || 
        voice.lang === voiceLang
    );
    
    if (selectedVoice) {
        utterance.voice = selectedVoice;
        utterance.lang = selectedVoice.lang;
    } else {
        utterance.lang = voiceLang;
    }
    
    // Configurar propiedades de la voz
    utterance.rate = options.rate || 1.0;
    utterance.pitch = options.pitch || 1.0;
    utterance.volume = options.volume || 1.0;
    
    // Eventos de la voz
    utterance.onstart = () => {
        isSpeaking = true;
        document.body.classList.add('is-speaking');
    };
    
    utterance.onend = () => {
        isSpeaking = false;
        document.body.classList.remove('is-speaking');
    };
    
    utterance.onerror = (event) => {
        isSpeaking = false;
        document.body.classList.remove('is-speaking');
        console.error('âŒ Error en la lectura:', event.error);
    };
    
    // Hablar con delay para evitar problemas
    setTimeout(() => {
        window.speechSynthesis.speak(utterance);
    }, 50);
}

// FunciÃ³n para obtener texto limpio de un elemento
function getCleanText(element) {
    if (!element) return '';
    
    // Clonar el elemento para no afectar el DOM original
    const clone = element.cloneNode(true);
    
    // Eliminar elementos que no queremos leer
    const unwantedElements = clone.querySelectorAll('script, style, svg, iframe');
    unwantedElements.forEach(el => el.remove());
    
    // Obtener texto y limpiarlo
    let text = clone.textContent || clone.innerText || '';
    
    // Limpiar espacios excesivos y caracteres especiales
    text = text.replace(/\s+/g, ' ').trim();
    text = text.replace(/[^\w\s\.\,\;\:\!\?\-\(\)]/g, '');
    
    return text;
}

// FunciÃ³n para activar el lector de voz
async function enableVoiceReader() {
    isVoiceReaderActive = true;
    document.body.classList.add('voice-reader-enabled');
    
    // Inicializar voces
    try {
        const voices = await initializeVoices();
        console.log('ðŸŽ™ï¸ Voces disponibles:', voices.length);
    } catch (error) {
        console.error('Error al cargar voces:', error);
    }
    
    // Agregar eventos de lectura
    addVoiceReaderEvents();
    
    // Crear indicador de ayuda flotante
    createVoiceHelpIndicator();
    
    // Mensaje de bienvenida
    setTimeout(() => {
        speakText('Lector de voz activado. Pasa el cursor sobre los elementos para escuchar su contenido.');
    }, 800);
    
    // Agregar listener para teclas de acceso rÃ¡pido
    document.addEventListener('keydown', handleVoiceReaderKeyboard);
    
    console.log('ðŸŽ¤ Lector de voz habilitado');
}

// FunciÃ³n para desactivar el lector de voz
function disableVoiceReader() {
    isVoiceReaderActive = false;
    document.body.classList.remove('voice-reader-enabled');
    
    // Detener cualquier lectura en curso
    if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
    }
    
    // Remover eventos de lectura automÃ¡tica
    removeVoiceReaderEvents();
    
    // Remover listener de teclado
    document.removeEventListener('keydown', handleVoiceReaderKeyboard);
    
    // Remover indicador de ayuda
    removeVoiceHelpIndicator();
    
    console.log('ðŸ”‡ Lector de voz deshabilitado');
}

// FunciÃ³n para agregar eventos de lectura
function addVoiceReaderEvents() {
    // Leer tÃ­tulos al hacer hover
    const headings = document.querySelectorAll('h1, h2, h3, h4, .section-title, .hero-title, .museum-title');
    headings.forEach(heading => {
        heading.addEventListener('mouseenter', handleHeadingHover);
        heading.addEventListener('focus', handleHeadingHover);
        heading.style.cursor = 'help';
        heading.setAttribute('tabindex', '0');
    });
    
    // Leer contenido de tarjetas al hacer clic
    const cards = document.querySelectorAll('.museum-card, .event-item, .thumbnail-item');
    cards.forEach(card => {
        card.addEventListener('click', handleCardClick);
        card.addEventListener('focus', handleCardClick);
        card.setAttribute('tabindex', '0');
    });
    
    // Leer botones al hacer hover
    const buttons = document.querySelectorAll('button, .btn, .nav-link, .filter-btn');
    buttons.forEach(button => {
        button.addEventListener('mouseenter', handleButtonHover);
        button.addEventListener('focus', handleButtonHover);
    });
    
    // Leer inputs al hacer focus
    const inputs = document.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
        input.addEventListener('focus', handleInputFocus);
    });
    
    console.log('ðŸŽ¯ Eventos de lectura agregados');
}

// FunciÃ³n para remover eventos de lectura
function removeVoiceReaderEvents() {
    const headings = document.querySelectorAll('h1, h2, h3, h4, .section-title, .hero-title, .museum-title');
    headings.forEach(heading => {
        heading.removeEventListener('mouseenter', handleHeadingHover);
        heading.removeEventListener('focus', handleHeadingHover);
        heading.style.cursor = '';
        heading.removeAttribute('tabindex');
    });
    
    const cards = document.querySelectorAll('.museum-card, .event-item, .thumbnail-item');
    cards.forEach(card => {
        card.removeEventListener('click', handleCardClick);
        card.removeEventListener('focus', handleCardClick);
        card.removeAttribute('tabindex');
    });
    
    const buttons = document.querySelectorAll('button, .btn, .nav-link, .filter-btn');
    buttons.forEach(button => {
        button.removeEventListener('mouseenter', handleButtonHover);
        button.removeEventListener('focus', handleButtonHover);
    });
    
    const inputs = document.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
        input.removeEventListener('focus', handleInputFocus);
    });
}

// Handlers de eventos
function handleHeadingHover(event) {
    if (!isVoiceReaderActive || isSpeaking) return;
    const text = getCleanText(event.target);
    if (text.length > 0 && text.length < 300) {
        speakText(text);
    }
}

function handleCardClick(event) {
    if (!isVoiceReaderActive) return;
    
    const title = event.currentTarget.querySelector('h3, h4, .museum-title, .event-title')?.textContent || '';
    const description = event.currentTarget.querySelector('.museum-description, .event-description')?.textContent || '';
    const location = event.currentTarget.querySelector('.museum-location, .event-location')?.textContent || '';
    
    let text = '';
    if (title) text += title + '. ';
    if (description) text += description + '. ';
    if (location) text += location + '.';
    
    if (text.trim()) {
        speakText(text.trim());
    }
}

function handleButtonHover(event) {
    if (!isVoiceReaderActive || isSpeaking) return;
    const text = getCleanText(event.target);
    if (text.length > 0 && text.length < 100) {
        speakText(text);
    }
}

function handleInputFocus(event) {
    if (!isVoiceReaderActive || isSpeaking) return;
    
    const input = event.target;
    const label = input.getAttribute('placeholder') || 
                  input.getAttribute('aria-label') || 
                  input.name || 
                  'Campo de entrada';
    
    const type = input.type;
    let announcement = '';
    
    if (type === 'text' || type === 'email' || type === 'password' || type === 'search') {
        announcement = `${label}. Campo de texto`;
    } else if (type === 'checkbox') {
        announcement = `${label}. Casilla de verificaciÃ³n ${input.checked ? 'marcada' : 'desmarcada'}`;
    } else if (input.tagName === 'SELECT') {
        announcement = `${label}. Lista desplegable`;
    } else if (input.tagName === 'TEXTAREA') {
        announcement = `${label}. Ãrea de texto`;
    } else {
        announcement = label;
    }
    
    speakText(announcement);
}

// Handler para teclado
function handleVoiceReaderKeyboard(event) {
    if (!isVoiceReaderActive) return;
    
    // Tecla R: Leer toda la pantalla actual
    if (event.key === 'r' || event.key === 'R') {
        event.preventDefault();
        readCurrentScreen();
    }
    
    // Tecla S: Detener lectura
    if (event.key === 's' || event.key === 'S') {
        event.preventDefault();
        stopReading();
    }
    
    // Tecla Escape: Detener lectura
    if (event.key === 'Escape') {
        stopReading();
    }
}

// FunciÃ³n para leer la pantalla actual
function readCurrentScreen() {
    // Obtener el tÃ­tulo principal visible
    const mainTitle = document.querySelector('.hero-title, .section-title:first-of-type, h1');
    const mainText = mainTitle ? getCleanText(mainTitle) : '';
    
    // Obtener descripciÃ³n
    const description = document.querySelector('.hero-subtitle, .section-subtitle, p');
    const descText = description ? getCleanText(description) : '';
    
    // Construir el texto completo
    let fullText = '';
    if (mainText) fullText += mainText + '. ';
    if (descText) fullText += descText + '. ';
    
    if (fullText) {
        speakText(fullText);
    }
}

// FunciÃ³n para detener la lectura
function stopReading() {
    if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
        isSpeaking = false;
        document.body.classList.remove('is-speaking');
        console.log('â¹ï¸ Lectura detenida');
    }
}

// FunciÃ³n para crear indicador de ayuda flotante
function createVoiceHelpIndicator() {
    if (document.querySelector('.voice-help-indicator')) {
        return;
    }
    
    const indicator = document.createElement('div');
    indicator.className = 'voice-help-indicator';
    indicator.innerHTML = `
        <strong>ðŸ’¡ Ayuda del Lector</strong>
        <p><strong>R</strong>: Leer pantalla completa</p>
        <p><strong>S</strong> o <strong>Esc</strong>: Detener lectura</p>
        <p>Pasa el cursor sobre elementos para escucharlos</p>
    `;
    
    document.body.appendChild(indicator);
    
    // Auto-ocultar despuÃ©s de 10 segundos
    setTimeout(() => {
        if (indicator && indicator.parentNode) {
            indicator.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            indicator.style.opacity = '0';
            indicator.style.transform = 'translateY(20px)';
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.remove();
                }
            }, 500);
        }
    }, 10000);
}

// FunciÃ³n para remover indicador de ayuda
function removeVoiceHelpIndicator() {
    const indicator = document.querySelector('.voice-help-indicator');
    if (indicator) {
        indicator.remove();
    }
}

// Conectar el botÃ³n de voz con la funcionalidad
const voiceBtn = document.getElementById('voiceBtn');
const toggleVoiceBtn = document.getElementById('toggleVoiceBtn');

if (voiceBtn) {
    voiceBtn.addEventListener('click', function() {
        this.classList.toggle('active');
        if (this.classList.contains('active')) {
            enableVoiceReader();
        } else {
            disableVoiceReader();
        }
    });
}

if (toggleVoiceBtn) {
    toggleVoiceBtn.addEventListener('click', function() {
        const voiceBtnMain = document.getElementById('voiceBtn');
        if (voiceBtnMain) {
            voiceBtnMain.click();
        }
    });
}

// ========================================
// FUNCIONALIDAD FUENTE GRANDE
// ========================================

let currentFontSize = 1; // 1 = normal, 1.25 = grande

// BotÃ³n de aumentar fuente en header
const fontSizeBtn = document.getElementById('fontSizeBtn');
if (fontSizeBtn) {
    fontSizeBtn.addEventListener('click', function() {
        this.classList.toggle('active');
        if (this.classList.contains('active')) {
            document.body.classList.add('large-font');
            currentFontSize = 1.25;
            showNotification(translations[currentLanguage]?.msg_font_increased || 'TamaÃ±o de fuente aumentado');
        } else {
            document.body.classList.remove('large-font');
            currentFontSize = 1;
            showNotification(translations[currentLanguage]?.msg_font_reset || 'TamaÃ±o de fuente restablecido');
        }
        // Guardar preferencia
        localStorage.setItem('largeFontEnabled', this.classList.contains('active'));
    });
}

// Botones del panel de accesibilidad
const increaseFontBtn = document.getElementById('increaseFontBtn');
const decreaseFontBtn = document.getElementById('decreaseFontBtn');
const resetFontBtn = document.getElementById('resetFontBtn');

if (increaseFontBtn) {
    increaseFontBtn.addEventListener('click', function() {
        document.body.classList.add('large-font');
        currentFontSize = 1.25;
        if (fontSizeBtn) fontSizeBtn.classList.add('active');
        showNotification(translations[currentLanguage]?.msg_font_increased || 'TamaÃ±o de fuente aumentado');
        localStorage.setItem('largeFontEnabled', 'true');
    });
}

if (decreaseFontBtn) {
    decreaseFontBtn.addEventListener('click', function() {
        document.body.classList.remove('large-font');
        currentFontSize = 1;
        if (fontSizeBtn) fontSizeBtn.classList.remove('active');
        showNotification(translations[currentLanguage]?.msg_font_decreased || 'TamaÃ±o de fuente reducido');
        localStorage.setItem('largeFontEnabled', 'false');
    });
}

if (resetFontBtn) {
    resetFontBtn.addEventListener('click', function() {
        document.body.classList.remove('large-font');
        currentFontSize = 1;
        if (fontSizeBtn) fontSizeBtn.classList.remove('active');
        showNotification(translations[currentLanguage]?.msg_font_reset || 'TamaÃ±o de fuente restablecido');
        localStorage.setItem('largeFontEnabled', 'false');
    });
}

// BotÃ³n de alto contraste
const contrastBtn = document.getElementById('contrastBtn');
const toggleContrastBtn = document.getElementById('toggleContrastBtn');

if (contrastBtn) {
    contrastBtn.addEventListener('click', function() {
        this.classList.toggle('active');
        document.body.classList.toggle('high-contrast');
        const isActive = this.classList.contains('active');
        showNotification(
            isActive 
                ? (translations[currentLanguage]?.msg_contrast_activated || 'Alto contraste activado')
                : (translations[currentLanguage]?.msg_contrast_deactivated || 'Alto contraste desactivado')
        );
        localStorage.setItem('highContrastEnabled', isActive);
    });
}

if (toggleContrastBtn) {
    toggleContrastBtn.addEventListener('click', function() {
        if (contrastBtn) {
            contrastBtn.click();
        }
    });
}

// Restaurar preferencias guardadas al cargar la pÃ¡gina
function restoreAccessibilityPreferences() {
    // Restaurar fuente grande
    const largeFontEnabled = localStorage.getItem('largeFontEnabled') === 'true';
    if (largeFontEnabled) {
        document.body.classList.add('large-font');
        if (fontSizeBtn) fontSizeBtn.classList.add('active');
        currentFontSize = 1.25;
    }
    
    // Restaurar alto contraste
    const highContrastEnabled = localStorage.getItem('highContrastEnabled') === 'true';
    if (highContrastEnabled) {
        document.body.classList.add('high-contrast');
        if (contrastBtn) contrastBtn.classList.add('active');
    }
    
    // Restaurar lector de voz
    const voiceReaderEnabled = localStorage.getItem('voiceReaderEnabled') === 'true';
    if (voiceReaderEnabled && voiceBtn) {
        voiceBtn.classList.add('active');
        enableVoiceReader();
    }
}

// Llamar a la funciÃ³n al cargar la pÃ¡gina
restoreAccessibilityPreferences();

// Sistema de notificaciones toast
function showNotification(message) {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    
    if (toast && toastMessage) {
        toastMessage.textContent = message;
        toast.classList.add('active');
        
        setTimeout(() => {
            toast.classList.remove('active');
        }, 3000);
    }
}
